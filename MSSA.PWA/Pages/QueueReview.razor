@page "/queue"
@using MSSA.PWA.Services
@using MountainStates.MSSA.Module.MSSA_Entries.Models
@inject IOfflineStorageService Storage
@inject ISyncService Sync
@inject NavigationManager Navigation

<PageTitle>Entry Queue</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h3>Entry Queue</h3>
            <p class="text-muted">Entries waiting to sync with the server</p>
        </div>
        <div class="col-auto">
            @if (isOnline)
            {
                <span class="badge bg-success">üü¢ Online</span>
            }
            else
            {
                <span class="badge bg-danger">üî¥ Offline</span>
            }
            <span class="badge bg-info">Queue: @queuedEntries.Count</span>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="alert alert-@statusMessageType alert-dismissible fade show" role="alert">
            @statusMessage
            <button type="button" class="btn-close" @onclick="ClearMessage"></button>
        </div>
    }

    <div class="row mb-3">
        <div class="col">
            <button class="btn btn-primary me-2" @onclick="LoadEntries">
                üîÑ Refresh
            </button>
            <button class="btn btn-success me-2" @onclick="SyncNow" disabled="@(!isOnline || isSyncing)">
                @if (isSyncing)
                {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                    <text>Syncing...</text>
                }
                else
                {
                    <text>‚¨ÜÔ∏è Sync Now</text>
                }
            </button>
            <button class="btn btn-secondary" @onclick="BackToEntry">
                ‚Üê Back to Entry Form
            </button>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading entries...</p>
        </div>
    }
    else if (!queuedEntries.Any())
    {
        <div class="alert alert-info">
            <h5>No entries in queue</h5>
            <p>All entries have been synced! Click "Back to Entry Form" to add more entries.</p>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header">
                <h5>Queued Entries (@queuedEntries.Count)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Trial ID</th>
                                <th>Handler ID</th>
                                <th>Dog ID</th>
                                <th>Class ID</th>
                                <th>Run Order</th>
                                <th>Placing</th>
                                <th>Total Score</th>
                                <th>Member</th>
                                <th>Comments</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in queuedEntries)
                            {
                                <tr>
                                    <td>@entry.TrialId</td>
                                    <td>@entry.HandlerId</td>
                                    <td>@entry.DogId</td>
                                    <td>@entry.ClassId</td>
                                    <td>@entry.RunOrder</td>
                                    <td>@entry.Placing</td>
                                    <td>
                                        @if (entry.TotalScore.HasValue)
                                        {
                                            @entry.TotalScore.Value.ToString("F1")
                                        }
                                        else
                                        {
                                            <text>-</text>
                                        }
                                    </td>
                                    <td>
                                        @if (entry.HandlerIsMSSAMember)
                                        {
                                            <span class="badge bg-success">‚úì</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(entry.Comments))
                                        {
                                            <span title="@entry.Comments">
                                                @(entry.Comments.Length > 30 ? entry.Comments.Substring(0, 30) + "..." : entry.Comments)
                                            </span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detailed View (Expandable) -->
        <div class="accordion mt-3" id="detailsAccordion">
            @for (int i = 0; i < queuedEntries.Count; i++)
            {
                var entry = queuedEntries[i];
                var index = i;
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading@index">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapse@index" aria-expanded="false" aria-controls="collapse@index">
                            Entry #@(index + 1) - Trial @entry.TrialId, Handler @entry.HandlerId, Dog @entry.DogId
                        </button>
                    </h2>
                    <div id="collapse@index" class="accordion-collapse collapse" aria-labelledby="heading@index" 
                         data-bs-parent="#detailsAccordion">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Basic Info</h6>
                                    <ul>
                                        <li><strong>Trial ID:</strong> @entry.TrialId</li>
                                        <li><strong>Handler ID:</strong> @entry.HandlerId</li>
                                        <li><strong>Dog ID:</strong> @entry.DogId</li>
                                        <li><strong>Class ID:</strong> @entry.ClassId</li>
                                        <li><strong>Run Order:</strong> @entry.RunOrder</li>
                                        <li><strong>Placing:</strong> @entry.Placing</li>
                                        <li><strong>MSSA Member:</strong> @(entry.HandlerIsMSSAMember ? "Yes" : "No")</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Scores</h6>
                                    <ul>
                                        <li><strong>O1:</strong> @entry.ObstacleScore1</li>
                                        <li><strong>O2:</strong> @entry.ObstacleScore2</li>
                                        <li><strong>O3:</strong> @entry.ObstacleScore3</li>
                                        <li><strong>O4:</strong> @entry.ObstacleScore4</li>
                                        <li><strong>O5:</strong> @entry.ObstacleScore5</li>
                                        <li><strong>O6:</strong> @entry.ObstacleScore6</li>
                                        <li><strong>O7:</strong> @entry.ObstacleScore7</li>
                                        <li><strong>O8:</strong> @entry.ObstacleScore8</li>
                                        <li><strong>O9:</strong> @entry.ObstacleScore9</li>
                                        <li><strong>Penalty:</strong> @entry.Penalty</li>
                                        <li><strong>Total:</strong> @entry.TotalScore?.ToString("F1")</li>
                                    </ul>
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(entry.Comments))
                            {
                                <div class="row mt-2">
                                    <div class="col">
                                        <h6>Comments</h6>
                                        <p>@entry.Comments</p>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<MSSA_Entry> queuedEntries = new List<MSSA_Entry>();
    private bool isOnline = false;
    private bool loading = false;
    private bool isSyncing = false;
    private string statusMessage;
    private string statusMessageType = "info";

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
        isOnline = await Sync.IsOnlineAsync();
        
        // Subscribe to sync events
        Sync.SyncStatusChanged += OnSyncStatusChanged;
    }

    private async Task LoadEntries()
    {
        loading = true;
        try
        {
            queuedEntries = await Storage.GetUnsyncedEntriesAsync();
        }
        catch (Exception ex)
        {
            ShowMessage($"Error loading entries: {ex.Message}", "danger");
        }
        finally
        {
            loading = false;
        }
    }

    private async Task SyncNow()
    {
        if (!isOnline)
        {
            ShowMessage("Cannot sync - device is offline", "warning");
            return;
        }

        isSyncing = true;
        ShowMessage("Syncing entries...", "info");
        
        try
        {
            var result = await Sync.SyncPendingEntriesAsync();
            
            if (result.IsSuccess)
            {
                ShowMessage($"‚úÖ Successfully synced {result.SuccessCount} entries!", "success");
            }
            else
            {
                ShowMessage($"‚ö†Ô∏è Sync completed: {result.SuccessCount} succeeded, {result.FailedCount} failed", "warning");
            }

            // Reload entries to reflect sync
            await LoadEntries();
        }
        catch (Exception ex)
        {
            ShowMessage($"‚ùå Sync error: {ex.Message}", "danger");
        }
        finally
        {
            isSyncing = false;
        }
    }

    private void BackToEntry()
    {
        Navigation.NavigateTo("/entry");
    }

    private void ShowMessage(string message, string type)
    {
        statusMessage = message;
        statusMessageType = type;
        StateHasChanged();
    }

    private void ClearMessage()
    {
        statusMessage = null;
    }

    private void OnSyncStatusChanged(object sender, SyncStatusEventArgs e)
    {
        isOnline = e.IsOnline;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Sync.SyncStatusChanged -= OnSyncStatusChanged;
    }
}
